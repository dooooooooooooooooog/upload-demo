<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Cloudinary 上傳示範</title>
</head>
<body>
  <h1>請選擇圖片並上傳</h1>
  <input type="file" id="fileInput" accept="image/*" />
  <button id="btnUpload">上傳</button>
  <p id="txtStatus"></p>

  <script>
    const cloudName    = 'dhitgg34o';          // 改成你的 Cloudinary Cloud name
    const uploadPreset = 'unsigned_preset';    // 你在控制台建立的 unsigned preset
    const analyzeUrl   = 'http://localhost:3000/analyze'; // 你的後端分析 API

    document.getElementById('btnUpload').onclick = async () => {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        alert('請先選擇檔案！');
        return;
      }
      const statusEl = document.getElementById('txtStatus');
      statusEl.innerText = '上傳中…';

      // 組 form data
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', uploadPreset);

      try {
        // 1. 上傳到 Cloudinary
        const res  = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
          { method: 'POST', body: form }
        );
        const data = await res.json();
        const imageUrl = data.secure_url;
        statusEl.innerHTML =
          `✔ 上傳完成！<br>圖片 URL：<a href="${imageUrl}" target="_blank">${imageUrl}</a>`;

        // 2. 自動呼叫後端分析
        statusEl.innerHTML += '<br>通知伺服器分析中…';
        const analyzeRes = await fetch(analyzeUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageUrl })
        });
        if (analyzeRes.ok) {
          statusEl.innerHTML += '<br>✅ 已通知伺服器並開始分析';
        } else {
          statusEl.innerHTML += `<br>❌ 分析伺服器錯誤：${analyzeRes.status}`;
        }
      } catch (err) {
        console.error(err);
        statusEl.innerText = '❌ 上傳或通知失敗，請檢查主控台錯誤';
      }
    };
  </script>
</body>
</html>
